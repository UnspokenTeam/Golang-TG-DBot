version: '3.9'
name: tg-dbot-prod

include:
  - 'caddy/docker-compose.caddy.yml'
  - 'clickhouse/docker-compose.clickhouse.yml'
  - 'observability/docker-compose.cadvisor.yml'
  - 'observability/docker-compose.uptrace.yml'
  - 'postgres/docker-compose.postgres.yml'
  - 'postgres/docker-compose.pgadmin.yml'
  - 'postgres/docker-compose.migrator.yml'
  - 'redis/docker-compose.rate-limiter.yml'
  - 'redis/docker-compose.uptrace-cache.yml'

services:
  bot-prod:
    image: ${REGISTRY_URL}/${REPO_URL}/${BOT_IMAGE_NAME}:${IMAGE_TAG}
    container_name: tg-dbot-telego-prod
    pull_policy: always
    restart: unless-stopped
    ports:
      - "8080:8080"
    env_file:
      - ../.env
    volumes:
      - ../.env:/.env:ro
      - ../configs/bot/commands.yaml:/commands.yaml:ro
    environment:
      UPTRACE_DSN: http://${UPTRACE_PROJECT_SECRET}@uptrace:14318?grpc=14317
    depends_on:
      - uptrace
      - rate-limiter-redis
    networks:
      - tg-dbot-network
    profiles: ["prod"]

networks:
  tg-dbot-network:
    driver: bridge